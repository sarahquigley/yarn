(function(){var a,b,c,d=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(a,b){this.source=a,this.destination=b}return a}(),b=function(){function a(a,b){this.nodes=null!=a?a:{},this.edges=null!=b?b:[],this.edges_by_node=d(this.edges_by_node,this)}return a.prototype.edges_by_node=function(a){return _.where(this.edges,{source:a})},a}(),c=function(){function a(){this.compile_edges=d(this.compile_edges,this),this.compile_page=d(this.compile_page,this),this.compile_graph=d(this.compile_graph,this)}return a.prototype.compile_graph=function(a){var c;return c=this.compile_edges(a),new b(a,c)},a.prototype.compile_page=function(a){throw"NotImplementedError"},a.prototype.compile_edges=function(a){throw"NotImplementedError"},a}(),this.Yarn||(this.Yarn={}),this.Yarn.Edge=a,this.Yarn.Graph=b,this.Yarn.Parser=c}).call(this),function(){var a,b,c,d=function(a,b){return function(){return a.apply(b,arguments)}},e=function(a,b){function c(){this.constructor=a}for(var d in b)f.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},f={}.hasOwnProperty;b=Yarn.Edge,c=Yarn.Parser,a=function(a){function c(){return this.compile_page=d(this.compile_page,this),this.compile_edges=d(this.compile_edges,this),c.__super__.constructor.apply(this,arguments)}return e(c,a),c.prototype.compile_edges=function(a){var c,d;return c=/\[[^[]+\]/g,d=[],_.each(a,function(a,e){var f,g,h,i,j;for(g=_.map(a.match(c),function(a){return _.trim(a,"[]")}),j=[],h=0,i=g.length;i>h;h++)f=g[h],j.push(d.push(new b(e,f)));return j}),d},c.prototype.compile_page=function(a){var b,c,d,e;c="";for(e in a)d=a[e],b="<h1><%- title %></h1>\n<p><%- text %></p>",c+=_.template(b)({title:e,text:d});return c},c}(c),this.Yarn.DebugParser=a}.call(this),function(){var a,b,c,d=function(a,b){return function(){return a.apply(b,arguments)}};a=new window.Yarn.DebugParser,b=function(){function a(a,b,c){this.id=null!=a?a:"yarn-"+_.uuid(),this.title=null!=b?b:"My New Story",this.nodes=null!=c?c:{},this._contains=d(this._contains,this),this.has_nodes=d(this.has_nodes,this),this.update_node_text=d(this.update_node_text,this),this.update_node_id=d(this.update_node_id,this),this.set_title=d(this.set_title,this),this.to_json=d(this.to_json,this),this.delete_node=d(this.delete_node,this),this.add_node=d(this.add_node,this)}return a.prototype.add_node=function(a,b){if(this._contains(a))throw"Node with title "+a+" already exists.";return this.nodes[a]=b},a.prototype.delete_node=function(a){if(!this._contains(a))throw"Node with title "+a+" does not exist.";return delete this.nodes[a]},a.prototype.to_json=function(){return{title:this.title,nodes:this.nodes}},a.prototype.set_title=function(a){this.title=a},a.prototype.update_node_id=function(a,b){if(this._contains(b)&&a!==b)throw"Node with title "+a+" already exists.";return a!==b?(this.nodes[b]=this.nodes[a],delete this.nodes[a]):void 0},a.prototype.update_node_text=function(a,b){return this.nodes[a]=b},a.prototype.has_nodes=function(){return!_.isEmpty(this.nodes)},a.prototype._contains=function(a){return _.contains(_.keys(this.nodes),a)},a.from_json=function(b,c){return new a(b,c.title,c.nodes)},a}(),c=function(){function a(a,b){this.storage=a,this.parser=b,this._load_story=d(this._load_story,this),this._story_ids=d(this._story_ids,this),this.stories=d(this.stories,this),this.save_story=d(this.save_story,this),this.clear=d(this.clear,this)}return a.prototype.clear=function(){var a,b,c,d,e;for(d=_.keys(this.storage),e=[],a=0,c=d.length;c>a;a++)b=d[a],e.push(_.startsWith(b,"yarn-")?this.storage.removeItem(b):void 0);return e},a.prototype.save_story=function(a){return this.storage.setItem(a.id,JSON.stringify(a.to_json())),this.storage.setItem(a.id+"-story",this.parser.compile_page(a.nodes))},a.prototype.stories=function(){var a,b,c,d,e;for(e={},d=this._story_ids(),a=0,c=d.length;c>a;a++)b=d[a],e[b]=this._load_story(b);return e},a.prototype._story_ids=function(){return _.filter(_.keys(this.storage),function(a){return _.startsWith(a,"yarn-")&&!_.endsWith(a,"-story")})},a.prototype._load_story=function(a){var c;try{return b.from_json(a,JSON.parse(this.storage.getItem(a)))}catch(d){throw c=d,"Error parsing story with id="+a+": "+c+"\n"}},a}(),window.Story=b,window.StoryStorage=c}.call(this),function(){var a=[].slice;angular.module("DebugEditorApp",["xeditable","ngRoute"]).run(["editableOptions",function(a){return a.theme="bs3"}]).config(["$routeProvider",function(a){return a.when("/stories",{templateUrl:"editor/editor.html",controller:"DebugEditorCtrl",controllerAs:"editor"}).when("/stories/:id",{templateUrl:"editor/editor.html",controller:"DebugEditorCtrl",controllerAs:"editor"}).otherwise({redirectTo:"/stories"})}]).factory("localStorage",function(){return localStorage}).factory("_",function(){return _}).service("debugParser",Yarn.DebugParser).factory("Story",function(){return Story}).factory("storyStorage",["localStorage","debugParser",function(a,b){return new StoryStorage(a,b)}]).controller("DebugEditorCtrl",["$scope","$window","$routeParams","$location","_","debugParser","Story","storyStorage",function(b,c,d,e,f,g,h,i){return b.stories=i.stories(),d.id&&(b.story=b.stories[d.id]),b.go_to_story=function(){var a;return a=b.story?b.story.id:"",e.path("/stories/"+a)},b.new_story=function(){return b.story=new h,b.go_to_story(),b.stories[b.story.id]=b.story,b.graph=g.compile_graph(b.story.nodes)},b.update_node_text=function(a,c){var d,e,f,h,i,j;for(b.story.update_node_text(a,c),b.graph=g.compile_graph(b.story.nodes),e=b.graph.edges_by_node(a),j=[],h=0,i=e.length;i>h;h++){d=e[h];try{j.push(b.story.add_node(d.destination,""))}catch(k){f=k}}return j},b.add_node_to_story=function(a,c){var d;null==c&&(c="");try{return b.story.add_node(a,""),b.update_node_text(a,c),b.new_node={}}catch(e){return d=e,alert(d)}},b.launch_story=function(){return c.open("/play.html#"+b.story.id),!0},b.clear_stories=function(){return b.stories={},b.story=void 0,b.go_to_story(),i.clear()},b.has_stories=function(){return!f.isEmpty(b.stories)},b.x_edit=function(){var b,c,d;c=arguments[0],b=2<=arguments.length?a.call(arguments,1):[];try{return c.apply(null,b),!0}catch(e){return d=e,""+d}},b.$watch("story",function(){return b.story?(i.save_story(b.story),b.graph=g.compile_graph(b.story.nodes)):void 0},!0)}])}.call(this);